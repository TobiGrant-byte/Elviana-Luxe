<script>
// Admin Panel JavaScript - COMPLETE FLAT STRUCTURE VERSION
(function() {
    // Admin password
    const ADMIN_PASSWORD = "elviana2024";
    const ADMIN_KEY = "elviana_admin_logged_in";
    
    // Server URL - SAME FOLDER
    const SERVER_URL = window.location.origin; // Current domain
    
    // Check login status
    function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem(ADMIN_KEY) === "true";
        if (isLoggedIn) {
            showDashboard();
        }
    }
    
    // Login function
    document.getElementById('loginBtn')?.addEventListener('click', function() {
        const password = document.getElementById('adminPassword').value;
        
        if (password === ADMIN_PASSWORD) {
            localStorage.setItem(ADMIN_KEY, "true");
            showDashboard();
        } else {
            alert('Incorrect password. Please try again.');
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPassword').focus();
        }
    });
    
    // Show dashboard
    function showDashboard() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'flex';
        
        loadOrdersFromServer();
    }
    
    // Logout function
    document.getElementById('logoutBtn')?.addEventListener('click', function() {
        localStorage.removeItem(ADMIN_KEY);
        location.reload();
    });
    
    // ========== SERVER FUNCTIONS ==========
    
    // Load orders from SERVER
    async function loadOrdersFromServer() {
        try {
            // Show loading
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #aaa;"><i class="fas fa-spinner fa-spin"></i> Loading orders from server...</td></tr>';
            
            // Fetch from server (same folder)
            const response = await fetch('get_orders.php');
            
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                // Store in localStorage for offline access
                localStorage.setItem('elvianaOrders', JSON.stringify(result.orders));
                
                // Update stats
                updateStats(result.orders);
                
                // Display orders
                if (result.orders.length === 0) {
                    document.getElementById('emptyOrders').style.display = 'block';
                    tableBody.innerHTML = '';
                } else {
                    document.getElementById('emptyOrders').style.display = 'none';
                    displayOrders(result.orders);
                }
            } else {
                alert('Server error: ' + (result.error || 'Unknown error'));
                loadOrdersFromLocal();
            }
            
        } catch (error) {
            console.error('Error loading from server:', error);
            alert('Cannot connect to server. Loading from local storage...');
            loadOrdersFromLocal();
        }
    }
    
    // Fallback to localStorage
    function loadOrdersFromLocal() {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        if (orders.length === 0) {
            document.getElementById('emptyOrders').style.display = 'block';
            document.getElementById('ordersTableBody').innerHTML = '';
        } else {
            document.getElementById('emptyOrders').style.display = 'none';
            displayOrders(orders);
            updateStats(orders);
        }
    }
    
    // Display orders in table
    function displayOrders(orders) {
        const tableBody = document.getElementById('ordersTableBody');
        
        if (!orders || orders.length === 0) {
            tableBody.innerHTML = '';
            document.getElementById('emptyOrders').style.display = 'block';
            return;
        }
        
        // Sort by date (newest first)
        orders.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        tableBody.innerHTML = orders.map(order => `
            <tr data-order-id="${order.id}">
                <td>
                    <div class="order-id">${order.id}</div>
                </td>
                <td class="customer-info">
                    <div class="customer-name">${order.customer?.name || 'No name'}</div>
                    <div class="customer-phone">ðŸ“± ${order.customer?.phone || 'No phone'}</div>
                    <div class="customer-address">ðŸ“ ${(order.customer?.address || 'No address').substring(0, 50)}${order.customer?.address?.length > 50 ? '...' : ''}</div>
                </td>
                <td>
                    <div class="order-date">${new Date(order.date).toLocaleDateString()}</div>
                    <div class="order-time" style="color: #666; font-size: 12px;">${new Date(order.date).toLocaleTimeString()}</div>
                </td>
                <td class="order-items">
                    ${(order.items || []).map(item => `
                        <div class="order-item">
                            <div class="item-name">${item.name || 'Unknown item'}</div>
                            <div class="item-details">${item.selectedColor || 'Default'} â€¢ Size ${item.selectedSize || 'One Size'}</div>
                            <div class="item-quantity">Qty: ${item.quantity || 1} Ã— $${(item.price || 0).toFixed(2)}</div>
                        </div>
                    `).join('')}
                </td>
                <td>
                    <div class="order-total">$${(order.total || 0).toFixed(2)}</div>
                </td>
                <td>
                    <span class="status-badge status-${order.status || 'pending'}">${order.status || 'pending'}</span>
                    <select class="status-select" data-order-id="${order.id}" onchange="updateOrderStatus('${order.id}', this.value)">
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                        <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                        <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn btn-view" title="View Details" onclick="viewOrderDetails('${order.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn btn-whatsapp" title="Contact on WhatsApp" onclick="contactCustomer('${order.id}')">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="action-btn btn-delete" title="Delete Order" onclick="deleteOrder('${order.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    // Update order stats
    function updateStats(orders) {
        const totalOrders = orders.length;
        const pendingOrders = orders.filter(o => o.status === 'pending').length;
        const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
        
        // Today's orders
        const today = new Date().toDateString();
        const todayOrders = orders.filter(order => 
            new Date(order.date).toDateString() === today
        ).length;
        
        document.getElementById('totalOrders').textContent = totalOrders;
        document.getElementById('pendingOrders').textContent = pendingOrders;
        document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
        document.getElementById('todayOrders').textContent = todayOrders;
    }
    
    // Update order status
    window.updateOrderStatus = async function(orderId, newStatus) {
        try {
            const response = await fetch('update_order.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: orderId,
                    status: newStatus
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update local storage
                const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
                const updatedOrders = orders.map(order => 
                    order.id === orderId ? { ...order, status: newStatus } : order
                );
                localStorage.setItem('elvianaOrders', JSON.stringify(updatedOrders));
                
                // Update the status badge
                const badge = document.querySelector(`[data-order-id="${orderId}"] .status-badge`);
                if (badge) {
                    badge.className = `status-badge status-${newStatus}`;
                    badge.textContent = newStatus;
                }
                
                updateStats(updatedOrders);
                alert(`Order #${orderId} status updated to ${newStatus}`);
            } else {
                alert('Failed to update on server: ' + result.error);
            }
            
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Network error. Status saved locally only.');
        }
    };
    
    // View order details
    window.viewOrderDetails = function(orderId) {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        const order = orders.find(o => o.id === orderId);
        
        if (order) {
            let details = `ðŸ“‹ ORDER DETAILS\n\n`;
            details += `Order ID: ${order.id}\n`;
            details += `Date: ${new Date(order.date).toLocaleString()}\n`;
            details += `Status: ${order.status || 'pending'}\n\n`;
            details += `ðŸ‘¤ CUSTOMER INFORMATION\n`;
            details += `Name: ${order.customer?.name || 'N/A'}\n`;
            details += `Phone: ${order.customer?.phone || 'N/A'}\n`;
            details += `Address: ${order.customer?.address || 'N/A'}\n`;
            if (order.customer?.email) details += `Email: ${order.customer.email}\n`;
            details += `\nðŸ“¦ ORDER ITEMS\n`;
            
            (order.items || []).forEach((item, index) => {
                details += `\n${index + 1}. ${item.name || 'Unknown item'}\n`;
                details += `   Color: ${item.selectedColor || 'Default'}\n`;
                details += `   Size: ${item.selectedSize || 'One Size'}\n`;
                details += `   Quantity: ${item.quantity || 1}\n`;
                details += `   Price: $${(item.price || 0).toFixed(2)} each\n`;
                details += `   Subtotal: $${((item.price || 0) * (item.quantity || 1)).toFixed(2)}\n`;
            });
            
            details += `\nðŸ’° TOTAL: $${(order.total || 0).toFixed(2)}\n`;
            details += `ðŸ’³ Payment Method: Cash on Delivery`;
            
            alert(details);
        } else {
            alert('Order not found!');
        }
    };
    
    // Contact customer on WhatsApp
    window.contactCustomer = function(orderId) {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        const order = orders.find(o => o.id === orderId);
        
        if (order && order.customer?.phone) {
            const customerPhone = order.customer.phone.replace(/\D/g, '');
            
            if (!customerPhone) {
                alert('Customer phone number is invalid.');
                return;
            }
            
            let message = `Hello ${order.customer.name || 'Valued Customer'},\n\n`;
            message += `This is Elviana Luxe regarding your order #${order.id}.\n`;
            message += `ðŸ“¦ Order Status: ${order.status || 'pending'}\n`;
            message += `ðŸ’° Total: $${(order.total || 0).toFixed(2)}\n\n`;
            
            if (order.status === 'pending') {
                message += `Your order is being processed. We'll update you once it's shipped.\n`;
            } else if (order.status === 'processing') {
                message += `Your order is being prepared for shipment.\n`;
            } else if (order.status === 'shipped') {
                message += `Your order has been shipped! Tracking details will be sent shortly.\n`;
            } else if (order.status === 'delivered') {
                message += `Your order has been delivered. Thank you for shopping with us!\n`;
            }
            
            message += `\nIf you have any questions, please reply to this message.\n\n`;
            message += `Best regards,\nElviana Luxe Team`;
            
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/${customerPhone}?text=${encodedMessage}`, '_blank');
            
        } else {
            alert('Customer phone number not found.');
        }
    };
    
    // Delete order
    window.deleteOrder = async function(orderId) {
        if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch('delete_order.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: orderId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update local storage
                const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
                const filteredOrders = orders.filter(o => o.id !== orderId);
                localStorage.setItem('elvianaOrders', JSON.stringify(filteredOrders));
                
                // Reload display
                loadOrdersFromServer();
                
                alert(`Order #${orderId} has been deleted.`);
            } else {
                alert('Failed to delete from server: ' + result.error);
            }
            
        } catch (error) {
            console.error('Error deleting order:', error);
            alert('Network error. Order deleted locally only.');
            
            // Delete from localStorage only
            const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
            const filteredOrders = orders.filter(o => o.id !== orderId);
            localStorage.setItem('elvianaOrders', JSON.stringify(filteredOrders));
            loadOrdersFromLocal();
        }
    };
    
    // Refresh orders
    document.getElementById('refreshOrders')?.addEventListener('click', function() {
        loadOrdersFromServer();
        const btn = this;
        btn.innerHTML = '<i class="fas fa-check"></i> Refreshed';
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        }, 2000);
    });
    
    // Export as CSV
    document.getElementById('exportCSV')?.addEventListener('click', function() {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        
        if (orders.length === 0) {
            alert('No orders to export.');
            return;
        }
        
        let csv = 'Order ID,Date,Customer Name,Phone,Address,Items,Total,Status\n';
        
        orders.forEach(order => {
            const items = (order.items || []).map(item => 
                `${item.name || 'Unknown'} (${item.selectedColor || 'Default'}, Size ${item.selectedSize || 'One Size'}) x${item.quantity || 1}`
            ).join('; ');
            
            csv += `${order.id},`;
            csv += `${new Date(order.date).toLocaleDateString()},`;
            csv += `"${(order.customer?.name || '').replace(/"/g, '""')}",`;
            csv += `${order.customer?.phone || ''},`;
            csv += `"${(order.customer?.address || '').replace(/"/g, '""')}",`;
            csv += `"${items.replace(/"/g, '""')}",`;
            csv += `$${(order.total || 0).toFixed(2)},`;
            csv += `${order.status || 'pending'}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `elviana-orders-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert(`Exported ${orders.length} orders as CSV.`);
    });
    
    // Export as JSON
    document.getElementById('exportJSON')?.addEventListener('click', function() {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        
        if (orders.length === 0) {
            alert('No orders to export.');
            return;
        }
        
        const json = JSON.stringify(orders, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `elviana-orders-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert(`Exported ${orders.length} orders as JSON.`);
    });
    
    // Print orders
    document.getElementById('printOrders')?.addEventListener('click', function() {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        
        if (orders.length === 0) {
            alert('No orders to print.');
            return;
        }
        
        let printContent = `
            <html>
            <head>
                <title>Elviana Luxe - Orders Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { color: #000; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    .header { text-align: center; margin-bottom: 30px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Elviana Luxe - Orders Report</h1>
                    <p>Generated: ${new Date().toLocaleString()}</p>
                    <p>Total Orders: ${orders.length}</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        orders.forEach(order => {
            const items = (order.items || []).map(item => 
                `${item.name || 'Unknown'} (${item.selectedColor || 'Default'}, Size ${item.selectedSize || 'One Size'}) x${item.quantity || 1}`
            ).join('<br>');
            
            printContent += `
                <tr>
                    <td>${order.id}</td>
                    <td>${new Date(order.date).toLocaleDateString()}</td>
                    <td>${order.customer?.name || 'N/A'}<br>${order.customer?.phone || 'N/A'}</td>
                    <td>${items}</td>
                    <td>$${(order.total || 0).toFixed(2)}</td>
                    <td>${order.status || 'pending'}</td>
                </tr>
            `;
        });
        
        printContent += `
                    </tbody>
                </table>
            </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    });
    
    // Clear old orders
    document.getElementById('clearOldOrders')?.addEventListener('click', function() {
        if (confirm('Clear orders older than 30 days? This action cannot be undone.')) {
            const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const recentOrders = orders.filter(order => 
                new Date(order.date) > thirtyDaysAgo
            );
            
            if (recentOrders.length === orders.length) {
                alert('No orders older than 30 days found.');
                return;
            }
            
            const deletedCount = orders.length - recentOrders.length;
            localStorage.setItem('elvianaOrders', JSON.stringify(recentOrders));
            loadOrdersFromLocal();
            
            alert(`Cleared ${deletedCount} orders older than 30 days. ${recentOrders.length} orders remaining.`);
        }
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
        
        // Allow Enter key for login
        document.getElementById('adminPassword')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginBtn').click();
            }
        });
    });
    
})();
</script>
