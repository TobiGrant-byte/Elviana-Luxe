<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin - Order Management - Elviana Luxe</title>
<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Admin Page Styles */
    .admin-container {
        max-width: 1400px;
        margin: 40px auto;
        padding: 0 5%;
    }
    
    .admin-header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 1px solid #333;
    }
    
    .admin-header h1 {
        color: #fff;
        font-size: 2.5rem;
        margin-bottom: 10px;
    }
    
    .admin-header p {
        color: #aaa;
        font-size: 16px;
    }
    
    /* Login Section */
    .login-section {
        max-width: 400px;
        margin: 100px auto;
        padding: 40px;
        background: rgba(255,255,255,0.02);
        border-radius: 16px;
        border: 1px solid #333;
        text-align: center;
    }
    
    .login-section h2 {
        color: #fff;
        margin-bottom: 30px;
    }
    
    .login-input {
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 20px;
        background: #111;
        border: 1px solid #333;
        border-radius: 8px;
        color: #fff;
        font-size: 16px;
    }
    
    .login-input:focus {
        outline: none;
        border-color: #fff;
    }
    
    .login-btn {
        width: 100%;
        padding: 15px;
        background: #fff;
        color: #000;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .login-btn:hover {
        background: #e0e0e0;
        transform: translateY(-2px);
    }
    
    /* Admin Dashboard */
    .admin-dashboard {
        display: none;
    }
    
    .stats-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
    }
    
    .stat-card {
        background: rgba(255,255,255,0.02);
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #333;
        text-align: center;
    }
    
    .stat-card h3 {
        color: #fff;
        font-size: 14px;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .stat-number {
        color: #fff;
        font-size: 32px;
        font-weight: bold;
        margin: 10px 0;
    }
    
    .stat-desc {
        color: #aaa;
        font-size: 14px;
    }
    
    /* Orders Table */
    .orders-section {
        margin-top: 40px;
    }
    
    .orders-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .orders-header h2 {
        color: #fff;
        font-size: 24px;
    }
    
    .refresh-btn {
        background: transparent;
        border: 1px solid #333;
        color: #fff;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }
    
    .refresh-btn:hover {
        border-color: #fff;
        color: #fff;
    }
    
    .orders-table-container {
        overflow-x: auto;
        background: rgba(255,255,255,0.02);
        border-radius: 12px;
        border: 1px solid #333;
        padding: 20px;
    }
    
    .orders-table {
        width: 100%;
        border-collapse: collapse;
        color: #fff;
    }
    
    .orders-table th {
        text-align: left;
        padding: 15px;
        border-bottom: 1px solid #333;
        font-weight: bold;
        color: #fff;
        background: rgba(255,255,255,0.05);
    }
    
    .orders-table td {
        padding: 15px;
        border-bottom: 1px solid #333;
        vertical-align: top;
    }
    
    .orders-table tr:hover {
        background: rgba(255,255,255,0.03);
    }
    
    .order-id {
        color: #fff;
        font-weight: bold;
        font-family: monospace;
    }
    
    .customer-info {
        min-width: 200px;
    }
    
    .customer-name {
        color: #fff;
        font-weight: bold;
        margin-bottom: 5px;
    }
    
    .customer-phone, .customer-address {
        color: #aaa;
        font-size: 13px;
        margin: 3px 0;
    }
    
    .order-items {
        min-width: 250px;
    }
    
    .order-item {
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px dashed #333;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .item-name {
        color: #fff;
        font-size: 14px;
    }
    
    .item-details {
        color: #aaa;
        font-size: 12px;
        margin: 3px 0;
    }
    
    .item-quantity {
        color: #fff;
        font-weight: bold;
    }
    
    .order-total {
        color: #fff;
        font-weight: bold;
        font-size: 16px;
    }
    
    .order-date {
        color: #aaa;
        font-size: 13px;
        white-space: nowrap;
    }
    
    /* Status Badges */
    .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .status-pending {
        background: rgba(255,193,7,0.2);
        color: #ffc107;
        border: 1px solid #ffc107;
    }
    
    .status-processing {
        background: rgba(0,123,255,0.2);
        color: #007bff;
        border: 1px solid #007bff;
    }
    
    .status-shipped {
        background: rgba(40,167,69,0.2);
        color: #28a745;
        border: 1px solid #28a745;
    }
    
    .status-delivered {
        background: rgba(23,162,184,0.2);
        color: #17a2b8;
        border: 1px solid #17a2b8;
    }
    
    .status-cancelled {
        background: rgba(220,53,69,0.2);
        color: #dc3545;
        border: 1px solid #dc3545;
    }
    
    /* Status Selector */
    .status-select {
        background: #111;
        color: #fff;
        border: 1px solid #333;
        border-radius: 6px;
        padding: 8px 12px;
        font-size: 14px;
        cursor: pointer;
        min-width: 120px;
    }
    
    .status-select:focus {
        outline: none;
        border-color: #fff;
    }
    
    /* Actions */
    .action-buttons {
        display: flex;
        gap: 10px;
    }
    
    .action-btn {
        background: transparent;
        border: 1px solid #333;
        color: #fff;
        width: 36px;
        height: 36px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .action-btn:hover {
        border-color: #fff;
        transform: translateY(-2px);
    }
    
    .btn-view:hover {
        background: rgba(0,123,255,0.1);
        border-color: #007bff;
        color: #007bff;
    }
    
    .btn-whatsapp:hover {
        background: rgba(37,211,102,0.1);
        border-color: #25D366;
        color: #25D366;
    }
    
    .btn-delete:hover {
        background: rgba(220,53,69,0.1);
        border-color: #dc3545;
        color: #dc3545;
    }
    
    /* Empty State */
    .empty-orders {
        text-align: center;
        padding: 60px 20px;
        color: #aaa;
    }
    
    .empty-orders i {
        font-size: 48px;
        color: #666;
        margin-bottom: 20px;
    }
    
    .empty-orders h3 {
        color: #fff;
        margin-bottom: 10px;
    }
    
    /* Export Section */
    .export-section {
        margin-top: 40px;
        padding: 20px;
        background: rgba(255,255,255,0.02);
        border-radius: 12px;
        border: 1px solid #333;
    }
    
    .export-section h3 {
        color: #fff;
        margin-bottom: 15px;
    }
    
    .export-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    .export-btn {
        background: transparent;
        border: 1px solid #333;
        color: #fff;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }
    
    .export-btn:hover {
        border-color: #fff;
        background: rgba(255,255,255,0.05);
    }
    
    /* Logout */
    .logout-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(255,255,255,0.1);
        border: 1px solid #333;
        color: #fff;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
        z-index: 100;
    }
    
    .logout-btn:hover {
        background: rgba(255,255,255,0.2);
        border-color: #fff;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .orders-table th,
        .orders-table td {
            padding: 10px 5px;
            font-size: 14px;
        }
        
        .orders-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }
        
        .customer-info, .order-items {
            min-width: 150px;
        }
        
        .logout-btn {
            position: relative;
            top: 0;
            right: 0;
            margin-bottom: 20px;
        }
    }
</style>
</head>
<body>
<header class="site-header">
<div class="brand">
<img src="/assets/Elviana Luxe logo.jpg" alt="Elviana Luxe logo" id="logo" />
<h1>ELVIANA LUXE</h1>
</div>
<nav class="top-links">
<a href="index.html"><i class="fas fa-home"></i> Home</a>
<a href="cart.html"><i class="fas fa-shopping-bag"></i> Cart</a>
<a href="admin.html" style="color: #fff;"><i class="fas fa-lock"></i> Admin</a>
</nav>
</header>

<main class="admin-container">
    <!-- Login Section (Shows First) -->
    <div id="loginSection" class="login-section">
        <h2><i class="fas fa-lock"></i> Admin Access</h2>
        <p style="color: #aaa; margin-bottom: 30px;">Enter the admin password to access order management</p>
        <input type="password" id="adminPassword" class="login-input" placeholder="Enter admin password">
        <button id="loginBtn" class="login-btn">Login to Dashboard</button>
        <p style="color: #666; margin-top: 20px; font-size: 14px;">Default password: elviana2024</p>
    </div>
    
    <!-- Admin Dashboard (Hidden until login) -->
    <div id="adminDashboard" class="admin-dashboard">
        <div class="admin-header">
            <h1><i class="fas fa-chart-line"></i> Order Management Dashboard</h1>
            <p>View and manage customer orders from Elviana Luxe</p>
        </div>
        
        <!-- Stats Cards -->
        <div class="stats-cards">
            <div class="stat-card">
                <h3>Total Orders</h3>
                <div class="stat-number" id="totalOrders">0</div>
                <p class="stat-desc">All time orders</p>
            </div>
            <div class="stat-card">
                <h3>Pending Orders</h3>
                <div class="stat-number" id="pendingOrders">0</div>
                <p class="stat-desc">Awaiting processing</p>
            </div>
            <div class="stat-card">
                <h3>Revenue</h3>
                <div class="stat-number" id="totalRevenue">$0</div>
                <p class="stat-desc">Total sales value</p>
            </div>
            <div class="stat-card">
                <h3>Today's Orders</h3>
                <div class="stat-number" id="todayOrders">0</div>
                <p class="stat-desc">Orders placed today</p>
            </div>
        </div>
        
        <!-- Orders Table -->
        <div class="orders-section">
            <div class="orders-header">
                <h2><i class="fas fa-shopping-cart"></i> Customer Orders</h2>
                <button id="refreshOrders" class="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div class="orders-table-container">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Date</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
                
                <div id="emptyOrders" class="empty-orders" style="display: none;">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>No orders yet</h3>
                    <p>Customer orders will appear here when they place orders through the website.</p>
                </div>
            </div>
        </div>
        
        <!-- Export Section -->
        <div class="export-section">
            <h3><i class="fas fa-download"></i> Export Orders</h3>
            <div class="export-buttons">
                <button id="exportCSV" class="export-btn">
                    <i class="fas fa-file-csv"></i> Export as CSV
                </button>
                <button id="exportJSON" class="export-btn">
                    <i class="fas fa-file-code"></i> Export as JSON
                </button>
                <button id="printOrders" class="export-btn">
                    <i class="fas fa-print"></i> Print Orders
                </button>
                <button id="clearOldOrders" class="export-btn" style="color: #ff6b6b;">
                    <i class="fas fa-trash"></i> Clear Old Orders
                </button>
            </div>
        </div>
    </div>
    
    <!-- Logout Button (Shows when logged in) -->
    <button id="logoutBtn" class="logout-btn" style="display: none;">
        <i class="fas fa-sign-out-alt"></i> Logout
    </button>
</main>

<footer class="site-footer">
    <p>Elviana Luxe Admin Panel Â© 2025 â€¢ Access restricted to authorized personnel only</p>
    </footer>
    
<script>
// Admin Panel JavaScript - COMPLETE FLAT STRUCTURE VERSION
(function() {
    // Admin password
    const ADMIN_PASSWORD = "elviana2024";
    const ADMIN_KEY = "elviana_admin_logged_in";
    
    // Server URL - SAME FOLDER
    const SERVER_URL = window.location.origin; // Current domain
    
    // Check login status
    function checkLoginStatus() {
        const isLoggedIn = localStorage.getItem(ADMIN_KEY) === "true";
        if (isLoggedIn) {
            showDashboard();
        }
    }
    
    // Login function
    document.getElementById('loginBtn')?.addEventListener('click', function() {
        const password = document.getElementById('adminPassword').value;
        
        if (password === ADMIN_PASSWORD) {
            localStorage.setItem(ADMIN_KEY, "true");
            showDashboard();
        } else {
            alert('Incorrect password. Please try again.');
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminPassword').focus();
        }
    });
    
    // Show dashboard
    function showDashboard() {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('adminDashboard').style.display = 'block';
        document.getElementById('logoutBtn').style.display = 'flex';
        
        loadOrdersFromServer();
    }
    
    // Logout function
    document.getElementById('logoutBtn')?.addEventListener('click', function() {
        localStorage.removeItem(ADMIN_KEY);
        location.reload();
    });
    
    // ========== SERVER FUNCTIONS ==========
    
    // Load orders from SERVER
    async function loadOrdersFromServer() {
        try {
            // Show loading
            const tableBody = document.getElementById('ordersTableBody');
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #aaa;"><i class="fas fa-spinner fa-spin"></i> Loading orders from server...</td></tr>';
            
            // Fetch from server (same folder)
            const response = await fetch('get_orders.php');
            
            if (!response.ok) {
                throw new Error(`Server error: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.success) {
                // Store in localStorage for offline access
                localStorage.setItem('elvianaOrders', JSON.stringify(result.orders));
                
                // Update stats
                updateStats(result.orders);
                
                // Display orders
                if (result.orders.length === 0) {
                    document.getElementById('emptyOrders').style.display = 'block';
                    tableBody.innerHTML = '';
                } else {
                    document.getElementById('emptyOrders').style.display = 'none';
                    displayOrders(result.orders);
                }
            } else {
                alert('Server error: ' + (result.error || 'Unknown error'));
                loadOrdersFromLocal();
            }
            
        } catch (error) {
            console.error('Error loading from server:', error);
            alert('Cannot connect to server. Loading from local storage...');
            loadOrdersFromLocal();
        }
    }
    
    // Fallback to localStorage
    function loadOrdersFromLocal() {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        if (orders.length === 0) {
            document.getElementById('emptyOrders').style.display = 'block';
            document.getElementById('ordersTableBody').innerHTML = '';
        } else {
            document.getElementById('emptyOrders').style.display = 'none';
            displayOrders(orders);
            updateStats(orders);
        }
    }
    
    // Display orders in table
    function displayOrders(orders) {
        const tableBody = document.getElementById('ordersTableBody');
        
        if (!orders || orders.length === 0) {
            tableBody.innerHTML = '';
            document.getElementById('emptyOrders').style.display = 'block';
            return;
        }
        
        // Sort by date (newest first)
        orders.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        tableBody.innerHTML = orders.map(order => `
            <tr data-order-id="${order.id}">
                <td>
                    <div class="order-id">${order.id}</div>
                </td>
                <td class="customer-info">
                    <div class="customer-name">${order.customer?.name || 'No name'}</div>
                    <div class="customer-phone">ðŸ“± ${order.customer?.phone || 'No phone'}</div>
                    <div class="customer-address">ðŸ“ ${(order.customer?.address || 'No address').substring(0, 50)}${order.customer?.address?.length > 50 ? '...' : ''}</div>
                </td>
                <td>
                    <div class="order-date">${new Date(order.date).toLocaleDateString()}</div>
                    <div class="order-time" style="color: #666; font-size: 12px;">${new Date(order.date).toLocaleTimeString()}</div>
                </td>
                <td class="order-items">
                    ${(order.items || []).map(item => `
                        <div class="order-item">
                            <div class="item-name">${item.name || 'Unknown item'}</div>
                            <div class="item-details">${item.selectedColor || 'Default'} â€¢ Size ${item.selectedSize || 'One Size'}</div>
                            <div class="item-quantity">Qty: ${item.quantity || 1} Ã— $${(item.price || 0).toFixed(2)}</div>
                        </div>
                    `).join('')}
                </td>
                <td>
                    <div class="order-total">$${(order.total || 0).toFixed(2)}</div>
                </td>
                <td>
                    <span class="status-badge status-${order.status || 'pending'}">${order.status || 'pending'}</span>
                    <select class="status-select" data-order-id="${order.id}" onchange="updateOrderStatus('${order.id}', this.value)">
                        <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                        <option value="processing" ${order.status === 'processing' ? 'selected' : ''}>Processing</option>
                        <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                        <option value="delivered" ${order.status === 'delivered' ? 'selected' : ''}>Delivered</option>
                        <option value="cancelled" ${order.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                    </select>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="action-btn btn-view" title="View Details" onclick="viewOrderDetails('${order.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="action-btn btn-whatsapp" title="Contact on WhatsApp" onclick="contactCustomer('${order.id}')">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                        <button class="action-btn btn-delete" title="Delete Order" onclick="deleteOrder('${order.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }
    
    // Update order stats
    function updateStats(orders) {
        const totalOrders = orders.length;
        const pendingOrders = orders.filter(o => o.status === 'pending').length;
        const totalRevenue = orders.reduce((sum, order) => sum + (order.total || 0), 0);
        
        // Today's orders
        const today = new Date().toDateString();
        const todayOrders = orders.filter(order => 
            new Date(order.date).toDateString() === today
        ).length;
        
        document.getElementById('totalOrders').textContent = totalOrders;
        document.getElementById('pendingOrders').textContent = pendingOrders;
        document.getElementById('totalRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
        document.getElementById('todayOrders').textContent = todayOrders;
    }
    
    // Update order status
    window.updateOrderStatus = async function(orderId, newStatus) {
        try {
            const response = await fetch('update_order.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: orderId,
                    status: newStatus
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update local storage
                const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
                const updatedOrders = orders.map(order => 
                    order.id === orderId ? { ...order, status: newStatus } : order
                );
                localStorage.setItem('elvianaOrders', JSON.stringify(updatedOrders));
                
                // Update the status badge
                const badge = document.querySelector(`[data-order-id="${orderId}"] .status-badge`);
                if (badge) {
                    badge.className = `status-badge status-${newStatus}`;
                    badge.textContent = newStatus;
                }
                
                updateStats(updatedOrders);
                alert(`Order #${orderId} status updated to ${newStatus}`);
            } else {
                alert('Failed to update on server: ' + result.error);
            }
            
        } catch (error) {
            console.error('Error updating status:', error);
            alert('Network error. Status saved locally only.');
        }
    };
    
    // View order details
    window.viewOrderDetails = function(orderId) {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        const order = orders.find(o => o.id === orderId);
        
        if (order) {
            let details = `ðŸ“‹ ORDER DETAILS\n\n`;
            details += `Order ID: ${order.id}\n`;
            details += `Date: ${new Date(order.date).toLocaleString()}\n`;
            details += `Status: ${order.status || 'pending'}\n\n`;
            details += `ðŸ‘¤ CUSTOMER INFORMATION\n`;
            details += `Name: ${order.customer?.name || 'N/A'}\n`;
            details += `Phone: ${order.customer?.phone || 'N/A'}\n`;
            details += `Address: ${order.customer?.address || 'N/A'}\n`;
            if (order.customer?.email) details += `Email: ${order.customer.email}\n`;
            details += `\nðŸ“¦ ORDER ITEMS\n`;
            
            (order.items || []).forEach((item, index) => {
                details += `\n${index + 1}. ${item.name || 'Unknown item'}\n`;
                details += `   Color: ${item.selectedColor || 'Default'}\n`;
                details += `   Size: ${item.selectedSize || 'One Size'}\n`;
                details += `   Quantity: ${item.quantity || 1}\n`;
                details += `   Price: $${(item.price || 0).toFixed(2)} each\n`;
                details += `   Subtotal: $${((item.price || 0) * (item.quantity || 1)).toFixed(2)}\n`;
            });
            
            details += `\nðŸ’° TOTAL: $${(order.total || 0).toFixed(2)}\n`;
            details += `ðŸ’³ Payment Method: Cash on Delivery`;
            
            alert(details);
        } else {
            alert('Order not found!');
        }
    };
    
    // Contact customer on WhatsApp
    window.contactCustomer = function(orderId) {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        const order = orders.find(o => o.id === orderId);
        
        if (order && order.customer?.phone) {
            const customerPhone = order.customer.phone.replace(/\D/g, '');
            
            if (!customerPhone) {
                alert('Customer phone number is invalid.');
                return;
            }
            
            let message = `Hello ${order.customer.name || 'Valued Customer'},\n\n`;
            message += `This is Elviana Luxe regarding your order #${order.id}.\n`;
            message += `ðŸ“¦ Order Status: ${order.status || 'pending'}\n`;
            message += `ðŸ’° Total: $${(order.total || 0).toFixed(2)}\n\n`;
            
            if (order.status === 'pending') {
                message += `Your order is being processed. We'll update you once it's shipped.\n`;
            } else if (order.status === 'processing') {
                message += `Your order is being prepared for shipment.\n`;
            } else if (order.status === 'shipped') {
                message += `Your order has been shipped! Tracking details will be sent shortly.\n`;
            } else if (order.status === 'delivered') {
                message += `Your order has been delivered. Thank you for shopping with us!\n`;
            }
            
            message += `\nIf you have any questions, please reply to this message.\n\n`;
            message += `Best regards,\nElviana Luxe Team`;
            
            const encodedMessage = encodeURIComponent(message);
            window.open(`https://wa.me/${customerPhone}?text=${encodedMessage}`, '_blank');
            
        } else {
            alert('Customer phone number not found.');
        }
    };
    
    // Delete order
    window.deleteOrder = async function(orderId) {
        if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch('delete_order.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: orderId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Update local storage
                const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
                const filteredOrders = orders.filter(o => o.id !== orderId);
                localStorage.setItem('elvianaOrders', JSON.stringify(filteredOrders));
                
                // Reload display
                loadOrdersFromServer();
                
                alert(`Order #${orderId} has been deleted.`);
            } else {
                alert('Failed to delete from server: ' + result.error);
            }
            
        } catch (error) {
            console.error('Error deleting order:', error);
            alert('Network error. Order deleted locally only.');
            
            // Delete from localStorage only
            const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
            const filteredOrders = orders.filter(o => o.id !== orderId);
            localStorage.setItem('elvianaOrders', JSON.stringify(filteredOrders));
            loadOrdersFromLocal();
        }
    };
    
    // Refresh orders
    document.getElementById('refreshOrders')?.addEventListener('click', function() {
        loadOrdersFromServer();
        const btn = this;
        btn.innerHTML = '<i class="fas fa-check"></i> Refreshed';
        setTimeout(() => {
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
        }, 2000);
    });
    
    // Export as CSV
    document.getElementById('exportCSV')?.addEventListener('click', function() {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        
        if (orders.length === 0) {
            alert('No orders to export.');
            return;
        }
        
        let csv = 'Order ID,Date,Customer Name,Phone,Address,Items,Total,Status\n';
        
        orders.forEach(order => {
            const items = (order.items || []).map(item => 
                `${item.name || 'Unknown'} (${item.selectedColor || 'Default'}, Size ${item.selectedSize || 'One Size'}) x${item.quantity || 1}`
            ).join('; ');
            
            csv += `${order.id},`;
            csv += `${new Date(order.date).toLocaleDateString()},`;
            csv += `"${(order.customer?.name || '').replace(/"/g, '""')}",`;
            csv += `${order.customer?.phone || ''},`;
            csv += `"${(order.customer?.address || '').replace(/"/g, '""')}",`;
            csv += `"${items.replace(/"/g, '""')}",`;
            csv += `$${(order.total || 0).toFixed(2)},`;
            csv += `${order.status || 'pending'}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `elviana-orders-${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert(`Exported ${orders.length} orders as CSV.`);
    });
    
    // Export as JSON
    document.getElementById('exportJSON')?.addEventListener('click', function() {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        
        if (orders.length === 0) {
            alert('No orders to export.');
            return;
        }
        
        const json = JSON.stringify(orders, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `elviana-orders-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        alert(`Exported ${orders.length} orders as JSON.`);
    });
    
    // Print orders
    document.getElementById('printOrders')?.addEventListener('click', function() {
        const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
        
        if (orders.length === 0) {
            alert('No orders to print.');
            return;
        }
        
        let printContent = `
            <html>
            <head>
                <title>Elviana Luxe - Orders Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h1 { color: #000; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    .header { text-align: center; margin-bottom: 30px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>Elviana Luxe - Orders Report</h1>
                    <p>Generated: ${new Date().toLocaleString()}</p>
                    <p>Total Orders: ${orders.length}</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        orders.forEach(order => {
            const items = (order.items || []).map(item => 
                `${item.name || 'Unknown'} (${item.selectedColor || 'Default'}, Size ${item.selectedSize || 'One Size'}) x${item.quantity || 1}`
            ).join('<br>');
            
            printContent += `
                <tr>
                    <td>${order.id}</td>
                    <td>${new Date(order.date).toLocaleDateString()}</td>
                    <td>${order.customer?.name || 'N/A'}<br>${order.customer?.phone || 'N/A'}</td>
                    <td>${items}</td>
                    <td>$${(order.total || 0).toFixed(2)}</td>
                    <td>${order.status || 'pending'}</td>
                </tr>
            `;
        });
        
        printContent += `
                    </tbody>
                </table>
            </body>
            </html>
        `;
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    });
    
    // Clear old orders
    document.getElementById('clearOldOrders')?.addEventListener('click', function() {
        if (confirm('Clear orders older than 30 days? This action cannot be undone.')) {
            const orders = JSON.parse(localStorage.getItem('elvianaOrders') || '[]');
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const recentOrders = orders.filter(order => 
                new Date(order.date) > thirtyDaysAgo
            );
            
            if (recentOrders.length === orders.length) {
                alert('No orders older than 30 days found.');
                return;
            }
            
            const deletedCount = orders.length - recentOrders.length;
            localStorage.setItem('elvianaOrders', JSON.stringify(recentOrders));
            loadOrdersFromLocal();
            
            alert(`Cleared ${deletedCount} orders older than 30 days. ${recentOrders.length} orders remaining.`);
        }
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkLoginStatus();
        
        // Allow Enter key for login
        document.getElementById('adminPassword')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginBtn').click();
            }
        });
    });
    
})();
</script>

